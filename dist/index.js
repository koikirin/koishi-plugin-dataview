import{send as _e,message as F,store as j,pick as ge,router as me,icons as L,Card as he}from"../client.js";import{defineComponent as Y,reactive as H,computed as $,watchEffect as W,watch as K,ref as ee,resolveComponent as C,resolveDirective as be,withDirectives as we,openBlock as _,createElementBlock as k,createElementVNode as y,toDisplayString as T,unref as J,createVNode as h,withCtx as p,createTextVNode as B,Fragment as ve,renderList as Ce,createBlock as R,withModifiers as E,resolveDynamicComponent as G,mergeProps as Q,nextTick as ye,createCommentVNode as ke,KeepAlive as xe}from"../vue.js";import{useRoute as $e}from"../vue-router.js";function ze(s){return s instanceof Date?`"d${s.toJSON()}"`:JSON.stringify(s,(i,o)=>{if(typeof o=="string")return"s"+o;if(typeof o=="object"){if(o instanceof Date)return"d"+new Date(o).toJSON();if(o===null)return null;const t=Array.isArray(o)?[]:{};for(const b in o)o[b]instanceof Date?(t[b]=new Date(o[b]),t[b].toJSON=void 0):t[b]=o[b];return t}return o})}function Se(s){if(s!==void 0)return JSON.parse(s,(i,o)=>typeof o=="string"?o[0]==="s"?o.slice(1):new Date(o.slice(1)):o)}async function I(s,...i){return Se(await _e(`database/${s}`,...i.map(ze)))}function te(s){const i=["B","KB","MB","GB"];for(const o in i)if(o&&s>1024)s/=1024;else return`${s.toFixed(1)} ${i[o]}`;return`${s.toFixed(1)} ${i[i.length-1]}`}function Z(s,i=""){return console.warn(s),i.length&&(i+="\uFF1A"),s instanceof Error?i+=s.name:typeof s=="string"&&(i+=s.split(`
`)[0]),F.error(i)}function P(s){return s.toString().padStart(2,"0")}function X(s){return[P(s.getHours()),P(s.getMinutes()),P(s.getSeconds())].join(":")}const Ve={class:"content-right"},De={class:"header"},Oe={class:"table-title"},Me={class:"operations"},Re={key:0},je={key:1},Te=["onParentDblclick"],Be=Y({__name:"data-table",props:{name:{}},setup(s,{expose:i}){const o=s,t=H({loading:true,filter:false,pageSize:void 0,offset:0,sort:null,changes:{},newRow:{}}),b=[30,50,100,150,200,500,1e3],c=$(()=>j.database.tables[o.name]);W(()=>{t.pageSize=t.pageSize||b[0]}),K(()=>t.pageSize,n=>{t.offset=Math.floor(t.offset/n)*n},{}),K(()=>c.value.fields,n=>{for(const e in c.value.fields)e in t.newRow||(t.newRow[e]="")},{immediate:true});const f=ee([]);async function g(){if(!o.name)return;t.loading=true;const n=t.sort&&{[t.sort.field]:{ascending:"asc",descending:"desc"}[t.sort.order]},e={offset:t.offset,limit:t.pageSize,sort:n};try{const a=t.filter?Object.keys(t.newRow).reduce((r,l)=>(t.newRow[l]&&(r[l]=t.newRow[l],r[l]=U(l,r[l])),r),{}):{};f.value=await I("get",o.name,a,e)}catch{}await ye(),t.loading=false}W(g);function S(){t.filter=!t.filter}i({updateData:g,switchFilter:S,state:t});const V=$({get:()=>Math.floor(t.offset/t.pageSize)+1,set:n=>t.offset=(n-1)*t.pageSize}),D=$(()=>{var e;const n={};for(const a in t.changes||{})for(const r in t.changes[a]){const l=v.value[r];(e=l.attrs)!=null&&e.validate&&!l.attrs.validate(t.changes[a][r].model)||(n[a]||(n[a]={}),n[a][r]=t.changes[a][r])}return n}),O=$(()=>!!Object.keys(t.changes||{}).length),N=$(()=>!!Object.keys(D.value||{}).length),z=$(()=>{var n;for(const e in c.value.fields){const a=v.value[e];if((n=a.attrs)!=null&&n.validate&&!a.attrs.validate(t.newRow[e]))return console.log(e),false}return true}),v=$(()=>Object.keys(c.value.fields).reduce((n,e)=>{const a=c.value.fields[e],r={clearable:false};let l,u;switch(a.type){case"time":return{...n,[e]:{is:"el-time-picker",attrs:r}};case"date":return{...n,[e]:{is:"el-date-picker",attrs:{...r,type:"date"}}};case"timestamp":return{...n,[e]:{is:"el-date-picker",attrs:{...r,type:"datetime"}}};case"integer":case"unsigned":u=1;case"float":case"double":case"decimal":l="number";break;default:l="text";break}const x=m=>{if(a.nullable===false&&!m.length)return false;switch(l.value==="number"&&(m=parseFloat(m)),a.type){case"unsigned":if(m<0)return false;case"integer":if(m%1!=0)return false;break;case"list":if(!m.startsWith("[")||!m.endsWith("]"))return false;break;case"json":if(m==="")return true;if(!m.startsWith("{")||!m.endsWith("}"))return false;break}return true};return n[e]={is:"el-input",attrs:{type:l,validate:x,step:u}},n},{}));function ne(n){n.order===null?t.sort=null:t.sort={field:n.prop,order:n.order}}function ae(n,{row:e,column:a,$index:r}){const l=c.value.fields[n].type,u=e[n];switch(l){case"json":return JSON.stringify(u);case"date":if(u instanceof Date)return u.toJSON().slice(0,10);break;case"time":if(u instanceof Date)return X(u);break;case"timestamp":if(u instanceof Date)return`${u.toJSON().slice(0,10)} ${X(u)}`;break}return u}function se(n,e){switch(c.value.fields[n].type){case"json":return JSON.stringify(e);case"time":if(typeof e!="string")return e;const[r,l,u]=e.split(":"),x=new Date;return x.setHours(parseInt(r),parseInt(l),parseInt(u)),x}return e}function U(n,e){switch(c.value.fields[n].type){case"unsigned":case"integer":case"decimal":case"float":case"double":return+e;case"boolean":return!!e;case"list":case"json":return JSON.parse(e)}return e}function A({row:n,column:e,$index:a},r=true){var l,u,x,m;return((u=(l=t.changes)==null?void 0:l[a])==null?void 0:u[e.label])===void 0?false:r?((m=(x=t.changes)==null?void 0:x[n.id])==null?void 0:m[e.label].model.value)!==n[e.label]:true}function oe(n,e,a){var r;(r=a.querySelector(".inner-cell"))==null||r.dispatchEvent(new Event("parent-dblclick"))}function le({row:n,column:e,$index:a}){A({row:n,column:e,$index:a},false)||(t.changes[a]===void 0&&(t.changes[a]={}),t.changes[a][e.label]=H({model:se(e.label,n[e.label])}))}function re({column:n,$index:e}){delete t.changes[e][n.label],Object.keys(t.changes[e]).length||delete t.changes[e]}function ie(){t.changes={}}async function ce(){t.loading=true;const n=[];for(const e in D.value)try{const a=f.value[e],r={};for(const l in D.value[e])r[l]=D.value[e][l].model,r[l]=U(l,r[l]);console.log("Update row: ",r),await I("set",o.name,ge(a,c.value.primary),r);for(const l in D.value[e])n.push({idx:e,field:l})}catch(a){Z(a,"\u66F4\u65B0\u6570\u636E\u5931\u8D25")}for(const e of n)delete t.changes[e.idx][e.field];for(const e in t.changes)Object.keys(t.changes[e]).length||delete t.changes[e];await g(),n.length&&F.success(`\u6210\u529F\u4FEE\u6539 ${n.length} \u9879\u6570\u636E`),t.loading=false}async function ue({row:n,$index:e}){t.loading=true;try{await I("remove",o.name,n),await g(),F.success("\u6210\u529F\u5220\u9664\u6570\u636E")}catch(a){Z(a,"\u6570\u636E\u5220\u9664\u5931\u8D25")}t.loading=false}async function de(){t.loading=true;try{const n=Object.keys(t.newRow).reduce((e,a)=>(t.newRow[a]&&(e[a]=t.newRow[a],e[a]=U(a,e[a])),e),{});console.log("Create row: ",n),await I("create",o.name,n),await g(),F.success("\u6210\u529F\u6DFB\u52A0\u6570\u636E");for(const e in t.newRow)t.newRow[e]=""}catch(n){Z(n,"\u6DFB\u52A0\u6570\u636E\u5931\u8D25")}t.loading=false}return(n,e)=>{const a=C("el-button"),r=C("k-icon"),l=C("k-button"),u=C("el-table-column"),x=C("el-popconfirm"),m=C("el-table"),fe=C("el-pagination"),pe=be("loading");return we((_(),k("div",Ve,[y("div",De,[y("span",Oe,T(n.name)+" "+T(c.value.size?`(${J(te)(c.value.size)})`:""),1),y("div",Me,[O.value?(_(),k("span",Re,[h(a,{type:"primary",disabled:!N.value,onClick:ce},{default:p(()=>[B("\u5E94\u7528\u4FEE\u6539")]),_:1},8,["disabled"]),h(a,{type:"danger",onClick:ie},{default:p(()=>[B("\u53D6\u6D88\u4FEE\u6539")]),_:1})])):(_(),k("span",je,"\u53CC\u51FB\u5355\u5143\u683C\u4FEE\u6539\u6570\u636E"))])]),h(m,{data:f.value,class:"data-table",style:{width:"100%"},height:"100%",border:true,"cell-class-name":({row:w,column:d,rowIndex:M,columnIndex:ut})=>A({row:w,column:d,$index:M},false)?"cell-changed":"",onSortChange:ne,onCellDblclick:oe},{default:p(()=>[(_(true),k(ve,null,Ce(Object.keys(c.value.fields),w=>(_(),R(u,{sortable:O.value?false:"custom",prop:w,label:w,fixed:c.value.primary.includes(w),resizable:true},{header:p(({column:d})=>[B(T(d.label)+" ",1),y("div",{class:"insertion",onClick:e[1]||(e[1]=E(()=>{},["stop"]))},[(_(),R(G(v.value[d.label].is),Q({onClick:e[0]||(e[0]=E(()=>{},["stop"])),modelValue:t.newRow[d.label],"onUpdate:modelValue":M=>t.newRow[d.label]=M},v.value[d.label].attrs||{},{size:"small"}),null,16,["modelValue","onUpdate:modelValue"]))])]),default:p(d=>[A(d,false)?(_(),R(G(v.value[d.column.label].is),Q({key:0,modelValue:t.changes[d.$index][d.column.label].model,"onUpdate:modelValue":M=>t.changes[d.$index][d.column.label].model=M},v.value[d.column.label].attrs||{},{size:"small"}),{suffix:p(()=>[h(l,{frameless:"",type:"danger",onClick:M=>re(d)},{default:p(()=>[h(r,{name:"times-full"})]),_:2},1032,["onClick"])]),_:2},1040,["modelValue","onUpdate:modelValue"])):(_(),k("div",{key:1,onParentDblclick:M=>le(d),class:"inner-cell"},T(ae(w,d)),41,Te))]),_:2},1032,["sortable","prop","label","fixed"]))),256)),h(u,{label:"\u64CD\u4F5C",width:"60",fixed:"right",align:"center"},{header:p(({column:w})=>[B(T(w.label)+" ",1),y("div",{class:"insertion",onClick:e[2]||(e[2]=E(()=>{},["stop"]))},[h(l,{frameless:"",disabled:!z.value||O.value,onClick:de},{default:p(()=>[B("\u63D2\u5165")]),_:1},8,["disabled"])])]),default:p(w=>[h(x,{onConfirm:d=>ue(w),title:"\u771F\u7684\u8981\u5220\u9664\u8FD9\u6761\u6570\u636E\u5417\uFF1F","confirm-button-text":"\u662F","cancel-button-text":"\u5426"},{reference:p(()=>[h(l,{frameless:"",type:"danger",disabled:O.value},{default:p(()=>[h(r,{name:"times-full"})]),_:1},8,["disabled"])]),_:2},1032,["onConfirm"])]),_:1})]),_:1},8,["data","cell-class-name"]),h(fe,{layout:"total, sizes, prev, pager, next, jumper",small:true,total:c.value.count,"page-sizes":b,"default-page-size":b[0],"page-size":t.pageSize,"onUpdate:pageSize":e[3]||(e[3]=w=>t.pageSize=w),"default-current-page":1,"current-page":V.value,"onUpdate:currentPage":e[4]||(e[4]=w=>V.value=w),disabled:O.value},null,8,["total","default-page-size","page-size","current-page","disabled"])])),[[pe,t.loading]])}}});const q=(s,i)=>{const o=s.__vccOpts||s;for(const[t,b]of i)o[t]=b;return o},Je=q(Be,[["__scopeId","data-v-f627f080"]]),qe={key:0},Ie=y("div",null,"\u5728\u5DE6\u4FA7\u9009\u62E9\u8981\u8BBF\u95EE\u7684\u6570\u636E\u8868",-1),Fe=Y({__name:"index",setup(s){function i(f){return Array.isArray(f)?f.join("/"):f||""}const o=ee(),t=$e(),b=$(()=>{var f,g,S,V;return console.log(111,(g=(f=o.value)==null?void 0:f.state)==null?void 0:g.filter),(V=(S=o.value)==null?void 0:S.state)!=null&&V.filter?"filter-off":"filter-on"}),c=$({get(){const f=i(t.params.name);return j.database.tables[f]?f:""},set(f){j.database.tables[f]||(f=""),me.replace("/database/"+f)}});return(f,g)=>{const S=C("k-icon"),V=C("k-tab-group"),D=C("el-scrollbar"),O=C("k-empty"),N=C("k-layout");return _(),R(N,{class:"page-database"},{header:p(()=>{var z;return[B(" \u6570\u636E\u5E93 "),(z=J(j).database)!=null&&z.size?(_(),k("span",qe,"("+T(J(te)(J(j).database.size))+")",1)):ke("",true)]}),menu:p(()=>[y("span",{class:"menu-item",onClick:g[0]||(g[0]=z=>{var v;return(v=o.value)==null?void 0:v.switchFilter()})},[h(S,{class:"menu-icon",name:b.value},null,8,["name"])]),y("span",{class:"menu-item",onClick:g[1]||(g[1]=z=>{var v;return(v=o.value)==null?void 0:v.updateData()})},[h(S,{class:"menu-icon",name:"refresh"})])]),left:p(()=>[h(D,null,{default:p(()=>[h(V,{data:J(j).database.tables,modelValue:c.value,"onUpdate:modelValue":g[2]||(g[2]=z=>c.value=z)},null,8,["data","modelValue"])]),_:1})]),default:p(()=>[(_(),R(xe,null,[c.value?(_(),R(Je,{key:c.value,name:c.value,ref_key:"table",ref:o},null,8,["name"])):(_(),R(O,{key:0},{default:p(()=>[Ie]),_:1}))],1024))]),_:1})}}});const Le={},Ne={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},Ue=y("path",{fill:"currentColor",d:"M224 512C100.3 512 0 476.2 0 432V80C0 35.82 100.3 0 224 0C347.7 0 448 35.82 448 80V432C448 476.2 347.7 512 224 512zM416 80.45C415.7 79.69 414.4 77.27 409.8 73.31C402.4 67.11 389.9 60.09 371.6 53.57C335.4 40.62 283.2 32 224 32C164.8 32 112.6 40.62 76.37 53.57C58.1 60.09 45.59 67.11 38.25 73.31C33.55 77.27 32.29 79.69 32 80.45V182.1C46.47 192.7 69.9 202.8 100.9 210.4C135.5 218.9 177.1 224 224 224C270 224 312.5 218.9 347.1 210.4C378.1 202.8 401.5 192.7 416 182.1V80.45zM416 219.5C398.8 228.4 377.9 235.8 354.8 241.5C317.3 250.7 272.2 256 224 256C175.8 256 130.7 250.7 93.22 241.5C70.11 235.8 49.18 228.4 32 219.5V310.1C46.47 320.7 69.9 330.8 100.9 338.4C135.5 346.9 177.1 352 224 352C270 352 312.5 346.9 347.1 338.4C378.1 330.8 401.5 320.7 416 310.1V219.5zM38.25 438.7C45.59 444.9 58.1 451.9 76.37 458.4C112.6 471.4 164.8 480 224 480C283.2 480 335.4 471.4 371.6 458.4C389.9 451.9 402.4 444.9 409.8 438.7C414.4 434.7 415.7 432.3 416 431.6V347.5C398.8 356.4 377.9 363.8 354.8 369.5C317.3 378.7 272.2 384 224 384C175.8 384 130.7 378.7 93.22 369.5C70.11 363.8 49.18 356.4 32 347.5V431.6C32.29 432.3 33.55 434.7 38.25 438.7zM416 431.4C416.1 431.3 416.1 431.3 416.1 431.3L416 431.4zM31.96 431.4C31.94 431.3 31.93 431.3 31.92 431.3L31.96 431.4zM31.96 80.56C31.93 80.65 31.92 80.7 31.92 80.7L31.96 80.56zM416.1 80.7C416.1 80.7 416.1 80.65 416 80.56z"},null,-1),Ae=[Ue];function Ee(s,i){return _(),k("svg",Ne,Ae)}const Ze=q(Le,[["render",Ee]]),Pe={},He={class:"k-icon refresh",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},We=y("path",{fill:"currentColor",d:"M496 40v160C496 213.3 485.3 224 472 224h-160C298.8 224 288 213.3 288 200s10.75-24 24-24h100.5C382.8 118.3 322.5 80 256 80C158.1 80 80 158.1 80 256s78.97 176 176 176c41.09 0 81.09-14.47 112.6-40.75c10.16-8.5 25.31-7.156 33.81 3.062c8.5 10.19 7.125 25.31-3.062 33.81c-40.16 33.44-91.17 51.77-143.5 51.77C132.4 479.9 32 379.5 32 256s100.4-223.9 223.9-223.9c79.85 0 152.4 43.46 192.1 109.1V40c0-13.25 10.75-24 24-24S496 26.75 496 40z"},null,-1),Ke=[We];function Ge(s,i){return _(),k("svg",He,Ke)}const Qe=q(Pe,[["render",Ge]]),Xe={},Ye={xmlns:"http://www.w3.org/2000/svg",height:"24",viewBox:"0 -960 960 960",width:"24"},et=y("path",{d:"m592-481-57-57 143-182H353l-80-80h487q25 0 36 22t-4 42L592-481ZM791-56 560-287v87q0 17-11.5 28.5T520-160h-80q-17 0-28.5-11.5T400-200v-247L56-791l56-57 736 736-57 56ZM535-538Z"},null,-1),tt=[et];function nt(s,i){return _(),k("svg",Ye,tt)}const at=q(Xe,[["render",nt]]),st={},ot={xmlns:"http://www.w3.org/2000/svg",height:"24",viewBox:"0 -960 960 960",width:"24"},lt=y("path",{d:"M440-160q-17 0-28.5-11.5T400-200v-240L168-736q-15-20-4.5-42t36.5-22h560q26 0 36.5 22t-4.5 42L560-440v240q0 17-11.5 28.5T520-160h-80Zm40-308 198-252H282l198 252Zm0 0Z"},null,-1),rt=[lt];function it(s,i){return _(),k("svg",ot,rt)}const ct=q(st,[["render",it]]);L.register("database",Ze);L.register("refresh",Qe);L.register("filter-on",ct);L.register("filter-off",at);const _t=s=>{s.page({path:"/database/:name*",name:"\u6570\u636E\u5E93",icon:"database",order:410,authority:4,fields:["database"],component:Fe}),s.slot({type:"numeric",component:he.numeric({title:"\u6570\u636E\u5E93\u4F53\u79EF",icon:"database",type:"size",fields:["database"],content:({database:i})=>i.size})})};export{_t as default};
